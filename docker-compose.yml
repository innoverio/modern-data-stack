version: '3'
services:
  spark-master:
    build: ./spark
    container_name: spark
    depends_on: 
      - hive-metastore
    ports:
      - "8080:8080"
      - "7077:7077"
    environment: 
      SPARK_NO_DAEMONIZE: "true"
    command: "start-master.sh"
  
  spark-worker1:
    build: ./spark
    container_name: spark-worker1
    depends_on: 
      - spark-master
    ports:
      - "8081:8081"
    environment: 
      SPARK_NO_DAEMONIZE: "true"
    command: "start-slave.sh spark://spark-master:7077"

  spark-worker2:
    build: ./spark
    container_name: spark-worker2
    depends_on: 
      - spark-master
    ports:
      - "8082:8081"
    environment: 
      SPARK_NO_DAEMONIZE: "true"
    command: "start-slave.sh spark://spark-master:7077"


  hive-metastore:
    build: ./hive
    container_name: hive-metastore
    ports:
      - '9083:9083' # Metastore Thrift
    environment:
      METASTORE_DB_HOSTNAME: mariadb
    depends_on:
      - mariadb

  mariadb:
    hostname: mariadb
    container_name: mariadb
    image: mariadb:10.5.8
    ports:
      - 3306:3306
    environment:
      MYSQL_ROOT_PASSWORD: admin
      MYSQL_USER: admin
      MYSQL_PASSWORD: admin
      MYSQL_DATABASE: metastore_db

  minio:
    hostname: minio
    image: 'minio/minio'
    container_name: minio
    ports:
      - '9000:9000'
    # volumes:
    #   - './minio/data:/data'
    command: server /data

  trino:
    hostname: trino
    image: 'trinodb/trino'
    container_name: trino
    ports:
      - '8888:8080'
    volumes:
      - './trino/trino-cli-358-executable.jar:/usr/bin/trino'
      - './trino/minio.properties:/etc/trino/catalog/minio.properties'

  # mc-job:
  #   image: 'minio/mc:latest'
  #   environment:
  #     MC_HOST_presto: "http://minioadmin:minioadmin@http://127.0.0.1:9000/"
  #   volumes:
  #     - './minio/data:/minio'
  #   entrypoint: |
  #     /bin/bash -c "
  #     /usr/bin/mc mb --quiet presto/customer-data-text;
  #     /usr/bin/mc mb --quiet presto/customer-data-orc;
  #     /usr/bin/mc mirror minio/customer-data-text presto/customer-data-text;
  #     "
